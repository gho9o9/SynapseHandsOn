
---
# 6. ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã¸ã®ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³  

ç¬¬6ç« ã¯ Data Lake Storage ä¸Šã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚  

## ã‚·ãƒŠãƒªã‚ª  
ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ Azure Purview ãŒç®¡ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’é€šã˜ã¦ç¬¬5ç« ã§ä½œæˆã—ãŸãƒ¬ãƒãƒ¼ãƒˆã®æºæ³‰ã¨ãªã£ã¦ã„ã‚‹ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ç‰¹å®šã—ã€ãã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ–°ãŸãªã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’å¾—ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚Azure Synapse Analytics ã¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‚’è¤‡æ•°æ­è¼‰ã—ã¾ã™ãŒã€ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ Synapse Serverless Spark Pool ã‚’åˆ©ç”¨ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ Synapse Serverless SQL Pool ã‚’åˆ©ç”¨ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è§¦ã‚Œã¦ã„ãã¾ã™ã€‚  

ã“ã®ã‚·ãƒŠãƒªã‚ªã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®å½¹å‰²ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚çŸ¢å°ã¯ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-04-11-11-49-41.png)  

| ã‚¢ã‚¤ã‚³ãƒ³ | ãƒªã‚½ãƒ¼ã‚¹ | å½¹å‰² |
| :---: | :---- | :---- |
| ![](images/SynapseTechBook_2022-04-06-08-57-48.png) | Azure Data Lake Storage | ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«é›†ç´„ã•ã‚ŒãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ Synapse Serverless Spark Pool ã‚„ Synapse Serverless SQL Pool ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰æœªç™ºè¦‹ã® Insight ã‚’å¾—ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãªãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã„ã¾ã™ã€‚ |
| ![](images/SynapseTechBook_2022-04-06-09-58-12.png) | Azure Purview | Azure Purview ã¯çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã‚’ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’é€šã˜ã¦çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã‚’æŠŠæ¡ã—ã€åˆ†æã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ç‰¹å®šã‚„è¦‹æ¥µã‚ã‚’è¡Œã„ã¾ã™ã€‚ |
| ![](images/SynapseTechBook_2022-04-02-11-47-49.png) | Synapse Serverless Spark Pool | ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ Spark ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯å†…ã®ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã«åˆ©ç”¨ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’å†åˆ©ç”¨ã®ãŸã‚ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«æ›¸ãæˆ»ã—ã¾ã™ã€‚ |
| ![](images/SynapseTechBook_2022-04-02-11-47-31.png) | Synapse Serverless SQL Pool | ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ SQL ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯å†…ã®ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã«åˆ©ç”¨ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’å†åˆ©ç”¨ã®ãŸã‚ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«æ›¸ãæˆ»ã—ã¾ã™ã€‚ |

---
# Let's get started

---
## 6-1. ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’å‚ç…§ã—ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚„ç³»è­œã‚’æŠŠæ¡ã™ã‚‹  

ç¬¬6ç« ã§ã¯ã¾ãšã¯ã˜ã‚ã«ç¬¬5ç« ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã®æœ€çµ‚æˆæœç‰©ã¨ãªã£ãŸ Power BI ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆSynapse Dedicated SQL Pool å†…ã® TaxiDataSummaryãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã«ã¤ã„ã¦ã€Azure Purview ã®ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’é€šã˜ã¦ãã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å…ƒã¨ãªã£ãŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚  

### 6-1-1. Purview ã‚«ã‚¿ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹

Synapse Studio ä¸Šéƒ¨ã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã¸ã€ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã‚ã‚‹ã€ŒTaxiDataSummaryã€ã‚’å…¥åŠ›ã— Purview ã®ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã«å¯¾ã—ã¦æ¤œç´¢ã‚’ã‹ã‘ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-25-52.png)  

æ¤œç´¢çµæœã‹ã‚‰ TaxiDataSummary ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-28-05.png)  

è¦‹ã¤ã‹ã£ãŸ TaxiDataSummary ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è©²å½“è³‡ç”£ã®æ§˜ã€…ãªä»˜å¸¯æƒ…å ±ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€Œç³»åˆ—ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—è©²å½“è³‡ç”£ãŒã©ã“ã‹ã‚‰ã©ã®ã‚ˆã†ãªå‡¦ç†ã‚’çµŒãŸãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-31-03.png)    

ã™ã‚‹ã¨ TaxiDataSummary ã¯ nyxtaxidata ã¨ TaxiLocationLookup ã‚’å…ƒã«ãƒ‡ãƒ¼ã‚¿åŠ å·¥ã•ã‚ŒãŸçµæœã‚»ãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  

### 6-1-2. ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã®ç³»è­œã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æºæ³‰ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’æŠŠæ¡ã™ã‚‹

ã“ã“ã§ã¯ nyxtaxidata ã‚’é¸æŠã—ã€Œã‚¢ã‚»ãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã— nyxtaxidata ã®è³‡ç”£æƒ…å ±ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-33-07.png)    

ã™ã‚‹ã¨ nyxtaxidata ãŒ Data Lake Storage ä¸Šã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç¤ºã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€Œé–¢é€£ã€ã‚¿ãƒ–ã‹ã‚‰è©²å½“ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºèªã§ãã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-35-08.png)  

NycTlcYellow ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã•ã‚‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®è³‡ç”£æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-36-27.png)  

---
## 6-2. Spark ã§ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†  

ãã‚Œã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰ç‰¹å®šã•ã‚ŒãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ Synapse Serverless Spark Pool ã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯æ¢ç´¢ã‚’è¡Œã„æ–°ãŸãªã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  

### 6-2-1. PySparkã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã™ã‚‹

å…ˆã»ã©ã® NycTlcYellow ã®è³‡ç”£æƒ…å ±ç”»é¢ã§ã€Œé–‹ç™ºã€ã‚¿ãƒ– ->ã€ŒNew notebookã€->ã€ŒLoad to DataFrameã€ã‚’é¸æŠã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-11-38-22.png)  

ã™ã‚‹ã¨ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒé–‹ã NycTlcYellow ã‚’ Spark ã® DataFrame ã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚  
NycTlcYellowï¼ˆCSV ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯å…ˆé ­è¡Œã«ãƒ˜ãƒƒãƒ€ã‚’æŒã¤ãŸã‚ã€ã“ã“ã§ã¯ã‚³ãƒ¼ãƒ‰å†…ã®ã€Œ, header=Trueã€ã®è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤–ã—ã¾ã™ã€‚   

```Python  
%%pyspark
df = spark.read.load('abfss://<ã‚³ãƒ³ãƒ†ãƒŠå>@<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net/raw/nyctaxidata/year=*/month=*/*_*_NycTlcYellow.csv', format='csv'
## Ifâ€¯headerâ€¯existsâ€¯uncommentâ€¯lineâ€¯below
, header=True
)
display(df.limit(10))
```  

ã“ã® PySpark ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œç’°å¢ƒã¨ãªã‚‹ã‚¢ã‚¿ãƒƒãƒå…ˆã¨ã—ã¦äº‹å‰æº–å‚™ã—ãŸ Synapse Serverless Spark Pool ã‚’æŒ‡å®šã—ãŸã®ã¡å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-12-00-04.png)  

***TODOï¼šã“ã“ã‹ã‚‰ç”¨æ„ã—ãŸãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«åˆ‡ã‚Šæ›¿ãˆã™ã‚‹ã€‚ã“ã“ã«æ‰‹é †ã‚’å…¥ã‚Œã‚‹***

ç¶šã‘ã¦ãƒ­ãƒ¼ãƒ‰ã—ãŸ DataFrame ã«å¯¾ã—ã¦ DataFrame API ã‚’åˆ©ç”¨ã—ç°¡å˜ãªãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã£ã¦ã¿ã¾ã™ã€‚ã€Œï¼‹ã‚³ãƒ¼ãƒ‰ã€ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-11-12-01-28.png)  

ã‚»ãƒ«å†…ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—å®Ÿè¡Œã—ã¾ã™ã€‚  

```Python
%%pyspark
# Use Data Frame API Operations to Filter Data
display(df.select("tpepPickupDateTime", "passengerCount", "totalAmount") \
.filter("passengerCount > 6 and totalAmount > 50.0") \
.sort(df.totalAmount.desc()))
```  

![](images/SynapseTechBook_2022-05-11-12-04-44.png)  

ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰ç‰¹å®šã—ãŸåˆ†æå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å³åº§ã«ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ãŒè¡Œãˆã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚  

### 6-2-2. Spark SQLã§ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã™ã‚‹

æ¬¡ã« DataFrame API ã§ã¯ãªã Spark SQL ã‚’åˆ©ç”¨ã—ãŸ SQL ãƒ©ã‚¤ã‚¯ãªè¨˜è¿°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã„ã¾ã™ã€‚  
ã¾ãšã¯ DataFrame ã‚’ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–ã—ã¾ã™ï¼ˆãƒãƒ³ã‚ºã‚ªãƒ³ç”¨ã«ãƒ‡ãƒ¼ã‚¿é‡ã‚’1ä¸‡ä»¶ã«çµã‚Šè¾¼ã‚“ã§ã„ã¾ã™ï¼‰ã€‚ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«ã‚’è¿½åŠ ã—ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚  

```Python
%%pyspark
# Create Local Temp View
df.limit(10000).createOrReplaceTempView('NYCTaxiDataTable') 
```

ã“ã“ã‹ã‚‰ã“ã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ Spark SQL ã§ã„ãã¤ã‹ã®ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«ã‚’è¿½åŠ ã—ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚  

```SQL
%%sql
--Check schema of NYCTaxiDataTable
DESCRIBE TABLE NYCTaxiDataTable
```

```SQL
%%sql
--Use SQL to count NYC Taxi Data records
SELECT COUNT(*) FROM NYCTaxiDataTable
```

```SQL
%%sql
-- Use SQL to filter NYC Taxi Data records
SELECT CAST(tpepPickupDateTime AS date)
  , tpepDropoffDateTime
  , passengerCount
  , totalAmount
FROM NYCTaxiDataTable
WHERE CAST(tpepPickupDateTime AS date) = '2019-01-01'
  AND passengerCount > 2
```

```SQL
%%sql
-- Use SQL to aggregate NYC Taxi Data records and visualize data
SELECT CASE paymentType
            WHEN 1 THEN 'Credit card'
            WHEN 2 THEN 'Cash'
            WHEN 3 THEN 'No charge'
            WHEN 4 THEN 'Dispute'
            WHEN 5 THEN 'Unknown'
            WHEN 6 THEN 'Voided trip'
        END AS PaymentType
  , count(*) AS TotalRideCount
FROM NYCTaxiDataTable
GROUP BY paymentType
ORDER BY TotalRideCount DESC
```

ã‚¯ã‚¨ãƒªã®çµæœã‚»ãƒƒãƒˆã¯ notebook ä¸Šã§å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚3ã¤ç›®ã®ã‚¯ã‚¨ãƒªçµæœã«å¯¾ã—ã¦ã€ã‚°ãƒ©ãƒ•ã‚’é¸æŠã—ã¦ã¿ã¦ãã ã•ã„ã€‚  
![](images/SynapseTechBook_2022-05-12-08-19-52.png)  

ã“ã®ã‚ˆã†ã« Spark SQL ã‚’åˆ©ç”¨ã—ãŸ SQL ãƒ©ã‚¤ã‚¯ãªè¨˜è¿°ã§ Data Lake Storage ä¸Šã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å³åº§ã‹ã¤å®¹æ˜“ã«ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãªæ¢ç´¢ã‚’è¡Œã†ã“ã¨ã§ãã¾ã™ã€‚  

### 6-2-3. Synapse Dedicated SQL Pool ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã¨ Spark ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã™ã‚‹  

ã“ã“ã¾ã§ã¯ Data Lake Storage ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã„ã¾ã—ãŸãŒã€åŒæ§˜ã« Dedicated SQL Pool å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ Synapse Serverless Spark Pool ã‹ã‚‰å®¹æ˜“ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã™ã€‚  
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ã¿ã§5ç« ã§ä½œæˆã—ãŸ Dedicated SQL Pool å†…ã® TaxiLocationLookup ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ­ãƒ¼ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®å‚ç…§ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å†…å®¹ã‚’ DataFrame ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

```Scala
%%spark
// <Dediacated SQL Pool å>.<ã‚¹ã‚­ãƒ¼ãƒå>.<ãƒ†ãƒ¼ãƒ–ãƒ«å>ã§æŒ‡å®šã—ã¾ã™ã€‚
val df_location = spark.read.sqlanalytics("dedicatedsql.dbo.TaxiLocationLookup")
```

ã“ã¡ã‚‰ã® DataFrame ã‚‚ Spark SQL ã‹ã‚‰æ‰±ãˆã‚‹ã‚ˆã†ã«ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–ã—ã¾ã—ã‚‡ã†ã€‚    

```Scala
%%spark
df_location.createOrReplaceTempView("NYCTaxiLocation")
```

ã“ã†ã™ã‚‹ã“ã¨ã§ Data Lake Storage ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨ Dedicated SQL Pool ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦åˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚  

```SQL
%%sql
select 
    VendorID
    , cast(tpepPickupDateTime as date) as PickUpDate
    , concat(year(tpepPickupDateTime), '-', format_string('%02d',month(tpepPickupDateTime),'##')) as PickUpYearMonth --Partition Key
    , cast(tpepPickupDateTime as timestamp) as PickUpDateTime
    , cast(tpepDropoffDateTime as date) as DropOffDate
    , cast(tpepDropoffDateTime as timestamp) as DropOffDateTime
    , passengerCount as PassengerCount
    , tripDistance as TripDistance
    , cast(puLocationId as int) as PickUpLocationID
    , pu.Zone as PickUpLocationZone
    , pu.Borough as PickUpLocationBorough
    , cast(doLocationId as int) as DropOffLocationID
    , do.Zone as DropOffLocationZone
    , do.Borough as DropOffLocationBorough
    , cast(paymentType as int) as PaymentTypeID
    , case paymentType
            when 1 then 'Credit card'
            when 2 then 'Cash'
            when 3 then 'No charge'
            when 4 then 'Dispute'
            when 5 then 'Unknown'
            when 6 then 'Voided trip'
        end as PaymentTypeDescription
    , cast(case when fareAmount < 0 then 0.00 else fareAmount end as decimal(8,2)) as FareAmount --Cleanse invalid data
    , cast(case when extra < 0 then 0.00 else extra end as decimal(8,2)) as ExtraAmount --Cleanse invalid data
    , cast(case when mtaTax < 0 then 0.00 else mtaTax end as decimal(8,2)) as MTATaxAmount --Cleanse invalid data
    , cast(case when tipAmount < 0 then 0.00 else tipAmount end as decimal(8,2)) as TipAmount --Cleanse invalid data
    , cast(case when tollsAmount < 0 then 0.00 else tollsAmount end as decimal(8,2)) as TollsAmount --Cleanse invalid data
    , cast(case when improvementSurcharge < 0 then 0.00 else improvementSurcharge end as decimal(8,2)) as ImprovementSurchargeAmount --Cleanse invalid data
    , cast(case when totalAmount < 0 then 0.00 else totalAmount end as decimal(8,2)) as TotalRideAmount --Cleanse invalid data
from NYCTaxiDataTable as rides
  join NYCTaxiLocation as pu
    on rides.PULocationID = pu.LocationID
  join NYCTaxiLocation as do
    on rides.DOLocationID = do.LocationID
where passengerCount > 0 --Data Cleanup Rules
  and year(tpepPickupDateTime) = 2019
limit 10
```
***TODO:é•·ã„ã‚¯ã‚¨ãƒªã¯æœ¬ã«ã‹ã‘ã‚‹ï¼Ÿã€€ã‹ã‘ã‚‹ã‹ã¯åˆ¥ã«ã‚¯ã‚¨ãƒªãƒ†ã‚­ã‚¹ãƒˆã‚’Githubå…±æœ‰ã—ã¦ã‚³ãƒ”ãƒšã§ãã‚‹ã‚ˆã†ã«ã—ãªã„ã¨***  

![](images/SynapseTechBook_2022-05-12-08-30-14.png)  

### 6-2-4. ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«æ›¸ãå‡ºã™  

åˆ†æã‚¯ã‚¨ãƒªã®çµæœã¯å†åˆ©ç”¨ã«å‚™ãˆã€Data Lake Storage ã‚„ Synapse Dediacated SQL Pool ã¸æ°¸ç¶šåŒ–ã—ã¾ã—ã‚‡ã†ã€‚    
ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã¯ Data Lake Storage ã¸ã®æ°¸ç¶šåŒ–ã®ä¾‹ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®å†’é ­ã§ã€Œlakedbã€ã¨ã„ã†åå‰ã§ãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆè«–ç†çš„ãªãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ï¼‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

***Tips: ãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ is ä½•ï¼Ÿ***
https://docs.microsoft.com/ja-jp/azure/synapse-analytics/database-designer/concepts-lake-database

```Python
%%pyspark

spark.sql("CREATE DATABASE lakedb")

df_preped = spark.sql(" \
    select \
        VendorID \
        , cast(tpepPickupDateTime as date) as PickUpDate \
        , concat(year(tpepPickupDateTime), '-', format_string('%02d',month(tpepPickupDateTime),'##')) as PickUpYearMonth \
        , cast(tpepPickupDateTime as timestamp) as PickUpDateTime \
        , cast(tpepDropoffDateTime as date) as DropOffDate \
        , cast(tpepDropoffDateTime as timestamp) as DropOffDateTime \
        , passengerCount as PassengerCount \
        , tripDistance as TripDistance \
        , cast(puLocationId as int) as PickUpLocationID \
        , pu.Zone as PickUpLocationZone \
        , pu.Borough as PickUpLocationBorough \
        , cast(doLocationId as int) as DropOffLocationID \
        , do.Zone as DropOffLocationZone \
        , do.Borough as DropOffLocationBorough \
        , cast(paymentType as int) as PaymentTypeID \
        , case paymentType \
                when 1 then 'Credit card' \
                when 2 then 'Cash' \
                when 3 then 'No charge' \
                when 4 then 'Dispute' \
                when 5 then 'Unknown' \
                when 6 then 'Voided trip' \
            end as PaymentTypeDescription \
        , cast(case when fareAmount < 0 then 0.00 else fareAmount end as decimal(8,2)) as FareAmount \
        , cast(case when extra < 0 then 0.00 else extra end as decimal(8,2)) as ExtraAmount \
        , cast(case when mtaTax < 0 then 0.00 else mtaTax end as decimal(8,2)) as MTATaxAmount  \
        , cast(case when tipAmount < 0 then 0.00 else tipAmount end as decimal(8,2)) as TipAmount  \
        , cast(case when tollsAmount < 0 then 0.00 else tollsAmount end as decimal(8,2)) as TollsAmount  \
        , cast(case when improvementSurcharge < 0 then 0.00 else improvementSurcharge end as decimal(8,2)) as ImprovementSurchargeAmount  \
        , cast(case when totalAmount < 0 then 0.00 else totalAmount end as decimal(8,2)) as TotalRideAmount  \
    from NYCTaxiDataTable as rides \
    join NYCTaxiLocation as pu \
        on rides.PULocationID = pu.LocationID \
    join NYCTaxiLocation as do \
        on rides.DOLocationID = do.LocationID \
    where passengerCount > 0 --Data Cleanup Rules \
    and year(tpepPickupDateTime) = 2019 \
")

df_preped.write.mode("overwrite").saveAsTable("lakedb.nyctaxidata_preped")  
```

ä½œæˆã—ãŸãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ Data Lake Storage ä¸Šã«ãƒ‡ãƒ¼ã‚¿ã®å®Ÿä½“ã‚’æŒã¤è«–ç†ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã¨ãªã‚Šã€Synapse Studio ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã«ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’å±•é–‹ã™ã‚‹å‰ã«ã€Œãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€Œæœ€æ–°ã®æƒ…å ±ã«æ›´æ–°ã™ã‚‹ã€ã‚’é¸æŠã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-08-53-18.png)  

ãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ Azure Synapse Analytics ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½ã«ã‚ˆã‚Š Synapse Serverless Spark Pool é–“ã«é™ã‚‰ãšã€ä»¥ä¸‹ã®ã‚ˆã†ã« Synapse Serverless SQL Pool ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-08-54-52.png)  

ã€Œæ¬¡ã«æ¥ç¶šã€ã«ã€Œçµ„ã¿è¾¼ã¿ã€ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ç”¨ã«ã€Œmasterã€ã‚’é¸æŠã—ãŸã®ã¡ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-08-59-11.png)  

---
## 6-3.  SQL ã§ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†  

æ¬¡ã« Synapse Serverless SQL Pool ã‚’åˆ©ç”¨ã—ã¦ 6-2 ã¨åŒæ§˜ã®ã‚·ãƒŠãƒªã‚ªã‚’æµã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  

### 6-3-1. CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Parquet ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã™ã‚‹

CSV å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æ‰±ã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯åˆ†æç”¨é€”ã«æœ€é©åŒ–ã•ã‚ŒãŸ Parquet å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ Synapse Serverless SQL Pool ã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãªãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Š DataFrame ã«ãƒ­ãƒ¼ãƒ‰ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ Parquet å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ Data Lake Storage ã«ä¿å­˜ã—ã¾ã™ï¼ˆãƒ‡ãƒ¢ç”¨ã«ãƒ‡ãƒ¼ã‚¿é‡ã‚’1ä¸‡ä»¶ã«çµã‚Šè¾¼ã‚“ã§ã„ã¾ã™ï¼‰ã€‚  

| é …ç›® | å€¤ |
| :---- | :---- |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå | Synapse ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ä½œæˆã—ãŸ Data Lake Storage ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ï¼ˆä¾‹ï¼šdatalake1130ï¼‰ |
| ã‚³ãƒ³ãƒ†ãƒŠå | Synapse ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ä½œæˆã—ãŸ Data Lake Storage ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ åã‚’æŒ‡å®šã—ã¾ã™ï¼ˆä¾‹ï¼šsynapsefsï¼‰ |  

```Python
%%pyspark

"""
df = spark.read.load('abfss://<ã‚³ãƒ³ãƒ†ãƒŠå>@<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net/raw/nyctaxidata/year=*/month=*/*_*_NycTlcYellow.csv', format='csv'
## Ifâ€¯headerâ€¯existsâ€¯uncommentâ€¯lineâ€¯below
, header=True
)
display(df.limit(10))
""" 

df.limit(10000).write.parquet("abfss://<ã‚³ãƒ³ãƒ†ãƒŠå>@<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net/raw/nyctaxidata-parquet/")
```

### 6-3-2. SQL ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã™ã‚‹

å‡ºåŠ›ã—ãŸ Parquet ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Synapse Studio ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã‹ã‚‰è¾¿ã‚Šã€å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€Œæ–°ã—ã„SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã€->ã€Œä¸Šä½100è¡Œã‚’é¸æŠã€ã‚’é¸æŠã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-05-50.png)  

ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã€ã¯ã€ŒParquet å½¢å¼ã€ã‚’é¸æŠã—ã€Œé©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-07-59.png)  

ã™ã‚‹ã¨ Parquet ãƒ•ã‚¡ã‚¤ãƒ« ã¸ã®ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ã‚¯ã‚¨ãƒªãŒè¨˜è¿°ã•ã‚ŒãŸ SQL ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¯ã‚¨ãƒªçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚  

```SQL  
-- This is auto-generated code
SELECT
    TOP 100 *
FROM
    OPENROWSET(
        BULK 'https://<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net/<ã‚³ãƒ³ãƒ†ãƒŠå>/raw/nyctaxidata-parquet/**',
        FORMAT = 'PARQUET'
    ) AS [result]
```

![](images/SynapseTechBook_2022-05-12-09-09-43.png)  


SQL ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚¯ã‚¨ãƒªã¯ FROM å¥ ã‚’é™¤ãã€Œ6-2-2. Spark SQL ã§ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã™ã‚‹ã€ã§å®Ÿè¡Œã—ãŸ Spark SQL ã¨å…¨ãåŒã˜ã‚¯ã‚¨ãƒªã«ãªã£ã¦ã„ã¾ã™ã€‚  

```SQL
SELECT CASE paymentType
            WHEN 1 THEN 'Credit card'
            WHEN 2 THEN 'Cash'
            WHEN 3 THEN 'No charge'
            WHEN 4 THEN 'Dispute'
            WHEN 5 THEN 'Unknown'
            WHEN 6 THEN 'Voided trip'
        END AS PaymentType
  , count(*) AS TotalRideCount
FROM
  OPENROWSET(
      BULK 'https://<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net/<ã‚³ãƒ³ãƒ†ãƒŠå>/raw/nyctaxidata-parquet/**',
      FORMAT = 'PARQUET'
  ) AS [result]
GROUP BY paymentType
ORDER BY TotalRideCount DESC
```

![](images/SynapseTechBook_2022-05-12-09-13-30.png)  

### 6-3-3. å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã™ã‚‹  

å…ˆã®ã‚¯ã‚¨ãƒªã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã‚¯ã‚¨ãƒªã®ä¸­ã§ç›´æ¥æŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚’å†…åŒ…ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

ã¾ãšå¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å…ˆã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚Synapse Studio ã®ãƒ¡ãƒ‹ãƒ¥ã‚’è¾¿ã‚Š SQL ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’èµ·å‹•ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-16-50.png)  

ä»¥ä¸‹ã® SQL ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã€ã€Œæ¬¡ã«æ¥ç¶šã€ã«ã€Œçµ„ã¿è¾¼ã¿ã€ã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ç”¨ã€ã«ã€Œmasterã€ã‚’é¸æŠã—ãŸã®ã¡å®Ÿè¡Œã—ã¾ã™ã€‚  

```SQL
CREATE DATABASE ServerlessDWH
```

![](images/SynapseTechBook_2022-05-12-09-19-41.png)  

æ¬¡ã«å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚Synapse Studio ã®ãƒ¡ãƒ‹ãƒ¥ã‚’è¾¿ã‚Šå‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€Œæ–°ã—ã„SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã€->ã€Œå¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã€ã‚’é¸æŠã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-21-50.png)  

ã€Œç¶šè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-25-55.png)  

ã€ŒSQLãƒ—ãƒ¼ãƒ«ã®é¸æŠã€ã¯ã€Œçµ„ã¿è¾¼ã¿ã€ã‚’é¸æŠã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é¸æŠã€ã¯ã€ŒServerlessDWHã€ã‚’é¸æŠã€ã€Œå¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«åã€ã¯ã€Œdbo.nyctaxidatatableã€ã‚’å…¥åŠ›ã—ã€Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é–‹ãã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-05-12-09-26-26.png)  

ã™ã‚‹ã¨å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©ãŒè¨˜è¿°ã•ã‚ŒãŸSQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚ã€Œæ¬¡ã«æ¥ç¶šã€ã«ã€Œçµ„ã¿è¾¼ã¿ã€ã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ç”¨ã€ã« ã€ŒServerlessDWHã€ã‚’é¸æŠã—ãŸã®ã¡å®Ÿè¡Œã—ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã¨å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã€ãã®å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹ 100ä»¶ ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã‚µãƒ³ãƒ—ãƒ«SELECTãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚  

```SQL
IF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'SynapseParquetFormat') 
	CREATE EXTERNAL FILE FORMAT [SynapseParquetFormat] 
	WITH ( FORMAT_TYPE = PARQUET)
GO

IF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = '<Data Lake Storage ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å>_<Data Lake Storage ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>_dfs_core_windows_net') 
	CREATE EXTERNAL DATA SOURCE [<Data Lake Storage ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å>_<Data Lake Storage ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>_dfs_core_windows_net] 
	WITH (
		LOCATION = 'abfss://<ã‚³ãƒ³ãƒ†ãƒŠå>@<ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>.dfs.core.windows.net' 
	)
GO

CREATE EXTERNAL TABLE nyctaxidatatable (
	[vendorID] nvarchar(4000),
	[tpepPickupDateTime] nvarchar(4000),
	[tpepDropoffDateTime] nvarchar(4000),
	[passengerCount] nvarchar(4000),
	[tripDistance] nvarchar(4000),
	[puLocationId] nvarchar(4000),
	[doLocationId] nvarchar(4000),
	[startLon] nvarchar(4000),
	[startLat] nvarchar(4000),
	[endLon] nvarchar(4000),
	[endLat] nvarchar(4000),
	[rateCodeId] nvarchar(4000),
	[storeAndFwdFlag] nvarchar(4000),
	[paymentType] nvarchar(4000),
	[fareAmount] nvarchar(4000),
	[extra] nvarchar(4000),
	[mtaTax] nvarchar(4000),
	[improvementSurcharge] nvarchar(4000),
	[tipAmount] nvarchar(4000),
	[tollsAmount] nvarchar(4000),
	[totalAmount] nvarchar(4000),
	[puYear] nvarchar(4000),
	[puMonth] nvarchar(4000)
	)
	WITH (
	LOCATION = 'raw/nyctaxidata-parquet/**',
	DATA_SOURCE = [<Data Lake Storage ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å>_<Data Lake Storage ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>_dfs_core_windows_net],
	FILE_FORMAT = [SynapseParquetFormat]
	)
GO


SELECT TOP 100 * FROM dbo.nyctaxidatatable
GO
```

![](images/SynapseTechBook_2022-05-12-09-28-12.png)  

ä½œæˆã—ãŸå¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã™ã‚‹ã‚¯ã‚¨ãƒªã«æ›¸ãæ›ãˆã¾ã—ã‚‡ã†ã€‚çµæœã¨ã—ã¦ã“ã®ã‚¯ã‚¨ãƒªã¯ã€Œ6-2-2. Spark SQL ã§ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã™ã‚‹ã€ã§å®Ÿè¡Œã—ãŸ Spark SQL ã¨å…¨ãåŒã˜ã‚¯ã‚¨ãƒªã«ãªã£ã¦ã„ã¾ã™ã€‚  

```SQL
SELECT CASE paymentType
            WHEN 1 THEN 'Credit card'
            WHEN 2 THEN 'Cash'
            WHEN 3 THEN 'No charge'
            WHEN 4 THEN 'Dispute'
            WHEN 5 THEN 'Unknown'
            WHEN 6 THEN 'Voided trip'
        END AS PaymentType
  , count(*) AS TotalRideCount
FROM dbo.nyctaxidatatable
GROUP BY paymentType
ORDER BY TotalRideCount DESC
```

![](images/SynapseTechBook_2022-05-12-09-30-16.png)  

### 6-3-4. ãƒ—ãƒ¬ãƒ‘ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«æ›¸ãå‡ºã™  

Synapse Serverless SQL Pool ã®å ´åˆã€ã‚¯ã‚¨ãƒªã®çµæœã‚’ Data Lake Storage ã¸æ›¸ãå‡ºã™ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« CETASï¼ˆCREATE EXTERNAL TABLE AS SELECTï¼‰ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  

```SQL
CREATE EXTERNAL TABLE total_ride_count_by_payment_type
WITH (
    LOCATION = 'preped_data/',
    DATA_SOURCE = [<Data Lake Storage ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å>_<Data Lake Storage ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>_dfs_core_windows_net],
    FILE_FORMAT = [SynapseParquetFormat]
)  
AS
SELECT CASE paymentType
            WHEN 1 THEN 'Credit card'
            WHEN 2 THEN 'Cash'
            WHEN 3 THEN 'No charge'
            WHEN 4 THEN 'Dispute'
            WHEN 5 THEN 'Unknown'
            WHEN 6 THEN 'Voided trip'
        END AS PaymentType
  , count(*) AS TotalRideCount
FROM dbo.nyctaxidatatable
GROUP BY paymentType
ORDER BY TotalRideCount DESC
GO

SELECT * FROM dbo.total_ride_count_by_payment_type
GO
```

![](images/SynapseTechBook_2022-05-12-09-34-26.png)  

***Tips***
https://docs.microsoft.com/ja-jp/azure/synapse-analytics/sql/create-external-table-as-select
https://docs.microsoft.com/ja-jp/azure/synapse-analytics/sql/develop-tables-cetas

***TODOï¼šğŸ‘‡å·¥äº‹ä¸­***
## 6-4. ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šAzure Purview ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ï¼ˆæœ¬æ›¸åŸ·ç­†æ™‚ç‚¹ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã§ãƒãƒªã‚·ãƒ¼ãƒ™ãƒ¼ã‚¹ã®åŒ…æ‹¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†  

Azure Purview ã«ã¯ã“ã®ç« ã®å†’é ­ã§åˆ©ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã®æŠŠæ¡ã ã‘ã§ã¯ãªãã€ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ï¼ˆæœ¬æ›¸åŸ·ç­†æ™‚ç‚¹ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚’ã‚ˆã‚Šå¼·å›ºã«ã™ã‚‹æ©Ÿèƒ½ãŒæ­è¼‰ã•ã‚Œã‚‹äºˆå®šã§ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã¯çµ„ç¹”ã§ä¿æœ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã‚’ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦åŒ…æ‹¬çš„ã«ç®¡ç†ã™ã‚‹ã“ã¨ãŒç›®çš„ã§ã™ã€‚Azure Data Lake Storage ã‚„ Azure SQL Database ãªã©å„ãƒ‡ãƒ¼ã‚¿è³‡ç”£ãã‚Œãã‚Œå€‹åˆ¥ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ãŸã‚ã®æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ãŒã€Azure Purview ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã«ã‚ˆã£ã¦ãƒ‡ãƒ¼ã‚¿è³‡ç”£å…¨ä½“ã‚’åŒ…æ‹¬çš„ã«ç®¡ç†ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚  

æœ¬æ›¸åŸ·ç­†æ™‚ç‚¹ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ãŒã€ç¾ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ç‚¹ã§ Azure Blob Storage ã¨ Azure Data Lake Storage ã«å¯¾ã—ã¦ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ãŸã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã®ã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
ãªãŠã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚ã‚‹ãŸã‚ UI ã‚„æ‰‹é †ã®å¤‰æ›´ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ç‚¹ã«ç•™æ„ãã ã•ã„ã€‚  

### 6-4-1. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã‚’æº–å‚™ã™ã‚‹

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

Azure Portal ãƒ¡ãƒ‹ãƒ¥ã‹ã‚‰ Cloud Shell ã‚’èµ·å‹•ã— PowerShell ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™ã€‚  
![](images/SynapseTechBook_2022-04-02-02-02-49.png)  
***TODOï¼šç”»åƒå·®ã—æ›¿ãˆ***

ä»¥ä¸‹ã® PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®<SubscriptionID>ã«ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®IDã‚’æŒ‡å®šã—ãŸã®ã¡ Cloud Shell ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å¼µã‚Šä»˜ã‘å®Ÿè¡Œã—ã¾ã™ã€‚  

``` PowerShell
# Login into the subscription
Connect-AzAccount -Subscription <SubscriptionID>
# Register the feature
Register-AzProviderFeature -FeatureName AllowPurviewPolicyEnforcement -ProviderNamespace Microsoft.Storage
```

Register-AzProviderFeature ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã§ RegistrationState ãŒ Registered ã«ãªã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç¹°ã‚Šè¿”ã—å®Ÿè¡Œå¯èƒ½ã§å®Ÿè¡Œçµæœã¨ã—ã¦æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  

***TODOï¼šç”»åƒæŒ¿å…¥***

#### 2. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼è¨­å®šã«å¿…è¦ãªæ¨©é™è¨­å®š



#### 3. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸ Azure Data Lake Storage ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### 6-4-2. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã‚’è¨­å®šã™ã‚‹

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã«ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã® Purview ã¸ã®ç™»éŒ²

#### 2. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã®è¨­å®š

### 6-4-3. ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã‚’å‹•ä½œç¢ºèªã™ã‚‹

allowã‚’ç¢ºèª
ãƒãƒªã‚·ãƒ¼å‰Šé™¤
NGã‚’ç¢ºèª




ä»¥ä¸Šã§ç¬¬6ç« ã®ãƒãƒ³ã‚ºã‚ªãƒ³ãŒå®Œäº†ã§ã™ã€‚  

# ã¾ã¨ã‚  

ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚  
ç¬¬6ç« ã§ã¯ã¾ãšã¯ã˜ã‚ã« Azure Purview ãŒç®¡ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’é€šã˜ã¦çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿è³‡ç”£ã‚’æŠŠæ¡ã—ã€åˆ†æã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ç‰¹å®šã‚„è¦‹æ¥µã‚ã‚’è¡Œã„ã¾ã—ãŸã€‚  
æ¬¡ã«ç‰¹å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ GUI æ“ä½œã‹ã‚‰ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚„ SQL ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å³åº§ã«èµ·å‹•ã—ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã„ã¾ã—ãŸã€‚Azure Synapse Analytics ã¯è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®é¸æŠè‚¢ã‚’ã‚‚ã¡ã€ç”¨é€”ã‚„ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã«å¿œã˜ã¦æœ€é©ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ Synapse Serverless Spark Pool ã«ã‚ˆã‚‹ PySpark/SparkSQL ã‚„ Synapse Serverless SQL Pool ã«ã‚ˆã‚‹ SQL ã«ã‚ˆã£ã¦ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯æ¢ç´¢ã‚’è¡Œã„ã¾ã—ãŸã€‚  
ã¾ãŸ Azure Synapse Analytics ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³å®Œã§æˆæœç‰©ã‚’å®¹æ˜“ã«å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ Synapse Serverless Spark Pool ã§ä½œæˆã—ãŸãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ Synapse Serverless SQL Pool ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãŒå®¹æ˜“ã«è¡Œãˆã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚  
