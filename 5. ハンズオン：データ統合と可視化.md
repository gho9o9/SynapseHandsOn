
---

# **5. ハンズオン：データ統合と可視化**  

本章では外部データソースとの多様なコネクタを持つ Synapse Pipeline を利用してサイロ化されたデータをデータレイクへ統合します。統合したデータは Synapse Dataflow による加工処理を通じ整形済みデータとして Synapse Dedicated に格納します。最後にデータ活用の典型例として、Power BI と連携し整形済みデータの可視化を行います。  

## **シナリオ**  
ここでは架空のタクシー事業者を想定し、タクシーの運行データの分析と可視化を行います。  

## **アーキテクチャ と このシナリオにおける各サービスの用途**  

![](https://o9o9storageshare.blob.core.windows.net/share/synapse_tech_book/images/SynapseTechBook_2022-01-13-14-53-38.png)

- Azure Blob Storage (Blob)  
  このシナリオでは Blob が分析対象となる生データの発生源とします。この生データを Synapse 内の Azure Datalake Store へ集約します。

- Azure SQL Database (SQLDB)  
  このシナリオでは SQLDB に生データを補完する参照データが格納されているものとします。このデータは Synapse Dedicated にコピーし腹持ちさせます。

- Azure Data Lake Storage (DataLake)  
  生データを集約するデータレイクとして利用します。

- Synapse Dataflow  
  データの加工処理を定義し実行します。

- Synapse Pipeline  
  データレイクへのデータ集約 や Synapse Dataflow によるデータの加工処理を呼び出す一連のデータパイプラインを定義します。

- Synapse Dedicated  
  構造化データを格納するデータウェアハウスとして利用します。このシナリオでは生データを補完する参照データ と 加工結果のデータを格納します。

- Power BI Service  
  Synapse Dedicated に格納された加工結果のデータを元にしたレポートを定義し公開します。

## **ハンズオンステップ概要**  

- 5-1. 分析に利用するデータを定義する  
  データパイプラインの定義やデータ加工処理の定義に先立ち、それら処理の入力元と出力先のデータを Synapse Intgrated Dataset として定義します。

- 5-2. データパイプラインを定義する  
  DataLake への生データ集約 と Synapse Dedicatedへの参照データコピーを Synapse Pipeline に定義し実行します。

- 5-3. データの加工処理を定義しデータパイプラインに追加する  
  データの加工と Synapse Dedicated への結果データ格納を Synapse Dataflow に定義し、データパイプラインに追加します。

- 5-4. 整形したデータを可視化する  
  整形したデータを利用し Power BI でレポートを作成し公開します。

---
# **ハンズオン**

---
## **5-1. 分析に利用するデータを定義する**  

データパイプラインの定義やデータ加工処理の定義に先立ち、それら処理の入力元と出力先のデータを Synapse Intgrated Dataset として定義します。

### **5-1-1. 入力元データセットの定義**

1. リンクサービス定義    

   1. Azure Blob Storage  

      | 項目 | 値 |
      | :---- | :---- |
      | 名前 | 例：blobstorage1130 |
      | サブスクリプション | ハンズオンに利用しているサブスクリプションを指定 |
      | ストレージアカウント名 | デプロイした Azure Blob Storage を指定 |

      ![](images/SynapseTechBook_2022-01-25-08-34-47.png)

      ![](images/SynapseTechBook_2022-01-25-08-36-13.png)

      ![](images/SynapseTechBook_2022-01-25-08-39-35.png)

   2. Azure SQL Database  

      | 項目 | 値 |
      | :---- | :---- |
      | 名前 | 例：mssqlserver1130 |
      | サブスクリプション | ハンズオンに利用しているサブスクリプションを指定 |
      | サーバー名 | デプロイした Azure SQL Database を指定 |
      | データベース名 | 作成した データベース を指定 |
      | 認証の種類 | SQL 認証 |
      | ユーザー名 | デプロイ時に指定したユーザー名を指定 |
      | パスワード | デプロイ時に指定したパスワードを指定 |

      ![](images/SynapseTechBook_2022-01-25-08-34-47.png)

      ![](images/SynapseTechBook_2022-01-25-08-45-22.png)

      ![](images/SynapseTechBook_2022-01-25-08-50-19.png)

2. データセット定義  

   1. Azure Blob Storage  

      | 項目 | 値 |
      | :---- | :---- |
      | 名前 | 例：BLOB_NYCTaxiData_CSV |
      | リンクサービス | 作成したリンクサービスを指定 |
      | コンテナ－ | handson |
      | ディレクトリ | source/nyctaxidata |
      | 先頭行をヘッダーとして | Yes |

      ![](images/SynapseTechBook_2022-01-25-08-21-18.png)

      ![](images/SynapseTechBook_2022-01-25-08-23-11.png)

      ![](images/SynapseTechBook_2022-01-25-08-27-37.png)

      ![](images/SynapseTechBook_2022-01-25-08-55-49.png)

   2. Azure SQL Database  

      | 項目 | 値 |
      | :---- | :---- |
      | 名前 | 例：SQLDB_TaxiLocationLookup |
      | リンクサービス | 作成したリンクサービスを指定 |
      | テーブル名 | dbo.TaxiLocationLookup |

      ![](images/SynapseTechBook_2022-01-25-08-21-18.png)

      ![](images/SynapseTechBook_2022-01-25-09-06-10.png)

      ![](images/SynapseTechBook_2022-01-25-09-13-26.png)

   3. 発行 
   
      ![](images/SynapseTechBook_2022-01-25-10-54-52.png)

      ![](images/SynapseTechBook_2022-01-25-10-55-02.png)

### **5-1-2. 出力先データセットの定義**

1. Synapse に統合する出力先の準備

   1. Synapse Data Lake
      
      Portal から Synapse デプロイ時に指定したファイルシステム配下にディレクトリ *raw/nyctaxidata* を作成します。

      ![](images/SynapseTechBook_2022-01-25-09-24-27.png)

   2. Synapse Dedicated SQL Pool

      Synapse Studio からクエリエディタを開き *dedicatedsql.sql* の内容を張り付け *TaxiDataSummaryテーブル* と *TaxiLocationLookupテーブル* 定義します。

      ![](images/SynapseTechBook_2022-01-25-10-29-11.png)

      ![](images/SynapseTechBook_2022-01-25-11-17-57.png)

2. データセット定義
   1. Synapse Data Lake  

      | 項目 | 値 |
      | :---- | :---- |
      | 名前 | 例：ADLS_NYCTaxiData_CSV |
      | リンクサービス | Synapse のデプロイの延長で自動作成されるADLSへのリンクサービスを指定 |
      | コンテナ－ | synapsefs |
      | ディレクトリ | raw/nyctaxidata |
      | 先頭行をヘッダーとして | Yes |

      ![](images/SynapseTechBook_2022-01-25-10-47-09.png)

      ![](images/SynapseTechBook_2022-01-25-10-47-22.png)

      ![](images/SynapseTechBook_2022-01-25-10-47-32.png)

      ![](images/SynapseTechBook_2022-01-25-10-47-41.png)
   
   2. Synapse Dedicated SQL Pool
   
      | 分類 | 項目 | 値 |
      | :---- | :---- | :---- |
      | 全般 | 名前 | 例：SQL_TaxiLocationLookup |
      | 接続 | リンクサービス | Synapse Dedicated SQL Pool のデプロイの延長で自動作成されるリンクサービスを指定 |
      | 接続 | DB Name | Synapse Dedicated SQL Pool のデプロイ時に指定した SQL Pool 名を指定 |
      | 接続 | テーブル | dbo.TaxiLocationLookup |

      ![](images/SynapseTechBook_2022-01-25-11-20-18.png)

      ![](images/SynapseTechBook_2022-01-25-11-20-27.png)

      ![](images/SynapseTechBook_2022-01-25-11-20-35.png)

      ![](images/SynapseTechBook_2022-01-25-12-57-26.png)

      ![](images/SynapseTechBook_2022-01-25-12-57-49.png)

      ![](images/SynapseTechBook_2022-01-25-12-58-18.png)

      同様に繰り返します。
      ***TODO：TaxiDataSummaryはPower BIレポートで即値dbo.TaxiDataSummaryが前提（pbitのパラメータにできる？）***

      | 分類 | 項目 | 値 |
      | :---- | :---- | :---- |
      | 全般 | 名前 | 例：SQL_TaxiDataSummary |
      | 接続 | リンクサービス | Synapse Dedicated SQL Pool のデプロイの延長で自動作成されるリンクサービスを指定 |
      | 接続 | DB Name | Synapse Dedicated SQL Pool のデプロイ時に指定した SQL Pool 名を指定 |
      | 接続 | テーブル | dbo.TaxiDataSummary |

      ![](images/SynapseTechBook_2022-01-25-12-58-51.png)

      ![](images/SynapseTechBook_2022-01-25-12-59-07.png)

   3. 発行 
   
      ![](images/SynapseTechBook_2022-01-25-11-24-01.png)

      ![](images/SynapseTechBook_2022-01-25-11-24-11.png)

---
## **5-2. データパイプラインを定義する**  

Datalake への生データ集約 と Synapse Dedicatedへの参照データコピーを Synapse Pipeline に定義し実行します。

### **5-2-1. データパイプラインの定義**

1. パイプラインの追加
   
   | 項目 | 値 |
   | :---- | :---- |
   | 名前 | 例：DataIntegration |
   | リンクサービス | 作成したリンクサービスを指定 |
   | テーブル名 | dbo.TaxiDataSummary |
      
   ![](images/SynapseTechBook_2022-01-25-11-33-37.png)
   
2. データレイクへの生データの集約
   
   コピーアクティビティ追加

   | 分類 | 項目 | 値 |
   | :---- | :---- | :---- |
   | 全般 | 名前 | 例：CopyTaxiDataFiles |
   | ソース | ソース データセット | 例：BLOB_NYCTaxiData_CSV |
   | ソース | ファイル パスの種類 | ワイルドカード ファイル パス |
   | ソース | ワイルドカード ファイル名 | *.csv |
   | シンク | シンク データセット | 例：ADLS_NYCTaxiData_CSV |

   ![](images/SynapseTechBook_2022-01-25-14-23-36.png)
   
3. Dedicated への参照データのコピー
   
   コピーアクティビティ追加

   | 分類 | 項目 | 値 |
   | :---- | :---- | :---- |
   | 全般 | 名前 | 例：CopyTaxiDataFiles |
   | ソース | ソース データセット | 例：BLOB_NYCTaxiData_CSV |
   | シンク | シンク データセット | 例：ADLS_NYCTaxiData_CSV |

   ![](images/SynapseTechBook_2022-01-25-13-09-02.png)

4. 発行
   
   ![](images/SynapseTechBook_2022-01-25-13-09-54.png)

### **5-2-2. データパイプラインの実行**

   ![](images/SynapseTechBook_2022-01-25-15-00-35.png)

   ![](images/SynapseTechBook_2022-01-25-14-16-32.png)

   ![](images/SynapseTechBook_2022-01-25-14-16-42.png)

   ![](images/SynapseTechBook_2022-01-25-14-54-26.png)

   ![](images/SynapseTechBook_2022-01-25-14-57-15.png)

   ![](images/SynapseTechBook_2022-01-25-15-00-09.png)

---
## **5-3. データの加工処理を定義しデータパイプラインに追加する**  

データの加工と Synapse Dedicated への結果データ格納を Synapse Dataflow に定義し、データパイプラインに追加します。

### **5-3-1. データフローの定義**  

1. スキーマのインポート
   
2. 

### **5-3-2. データパイプラインへの追加と再実行**

---
## **5-4. 整形したデータを可視化する**  

整形したデータを利用し Power BI でレポートを作成し公開します。

### **5-4-1. Synapse と Power BI ワークスペースをリンク**

### **5-4-2. Synapse Studio でのレポート作成と共有**

